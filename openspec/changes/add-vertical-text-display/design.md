## Context

NovelViewerは現在、`SingleChildScrollView` + `SelectableText.rich` による横書きスクロール表示のみをサポートしている。テキストはルビテキストパーサーでパースされ、`TextSpan` / `WidgetSpan` のツリーとして描画されている。設定画面はプレースホルダー状態で、設定の永続化レイヤーは存在しない。

参考情報として、Qiita記事（`Wrap`ウィジェットによる縦書き実装）と`yokogaki`パッケージ（横書き用だがルビ・禁則処理対応）を調査済み。

## Goals / Non-Goals

**Goals:**
- 縦書き（上→下、右→左）テキスト表示の実現
- 縦書き時のルビテキスト表示（ベーステキスト右側配置）
- 縦書き時のページネーション表示（スクロールではなくページ単位）
- 横矢印キー（←→）によるページ送り・戻り
- 設定画面での縦書き／横書き切り替え
- 設定の永続化（`shared_preferences`）

**Non-Goals:**
- フォントサイズや行間の設定変更（将来の拡張として残す）
- 禁則処理の完全実装（基本的な改行処理のみ）
- 縦書きモードでのテキスト選択・コピー機能（技術的制約により横書きのみ）
- 横書きモードのページネーション対応（横書きは従来通りスクロール）

## Decisions

### 1. 縦書きレンダリング方式: Wrapウィジェット方式

**選択**: `Wrap(direction: Axis.vertical)` + `textDirection: TextDirection.rtl` + 1文字ずつ描画

**理由**:
- Qiita記事で実証済みのアプローチで、Flutterの標準ウィジェットのみで実現可能
- 文字ごとにWidgetを生成するため、縦書き用文字マッピングや句読点の位置調整が容易
- CustomPainter方式と比較して実装がシンプルで保守しやすい

**代替案**:
- CustomPainter + TextPainter: より細かい制御が可能だが、改行処理やルビ配置の実装が複雑
- yokogakiパッケージ: 横書き専用であり、縦書きには対応していない

### 2. 文字マッピング: 縦書き用互換文字テーブル

**選択**: 横書き文字→縦書き互換文字のマッピングテーブルを`Map<String, String>`で定義

**マッピング対象**:
- 句読点: `。` → `︒`, `、` → `︑`
- 括弧: `（` → `︵`, `）` → `︶`, `「` → `﹁`, `」` → `﹂` 等
- 長音: `ー` → 回転なし（縦書きではそのまま縦方向に表示される）
- 三点リーダー: `…` → `︙`

### 3. ページネーション: 表示領域に基づくページ分割

**選択**: 表示領域のサイズを計算し、文字数と行数からページ境界を動的に決定

**理由**:
- ウィンドウサイズの変更に対応できる
- フォントサイズ変更への将来的な拡張が容易

**ページ送り方向**:
- `←`キー: 次のページ（縦書きは右→左なので、左キーで進む）
- `→`キー: 前のページ

### 4. 縦書きルビテキスト: Row配置（右側にルビ）

**選択**: 横書きでの`Column`（上にルビ）を、縦書きでは`Row`（右側にルビ）に切り替え

**理由**:
- 既存の`RubyTextWidget`の構造を活かしつつ、レイアウト方向のみ変更する
- 縦書きの日本語組版規則に従い、ルビはベーステキストの右側に配置

### 5. 設定の永続化: shared_preferences

**選択**: `shared_preferences`パッケージを使用

**理由**:
- Flutterの標準的なKey-Value永続化ソリューション
- macOS対応済み
- 簡単な設定値（表示モードのenum）の保存に適切
- Riverpodの`StateNotifier`と組み合わせてリアクティブに設定変更を反映

### 6. アーキテクチャ: 表示モード分岐方式

**選択**: `TextViewerPanel`内で表示モードに応じてウィジェットを切り替え

```
TextViewerPanel
├── horizontalモード → 既存のSingleChildScrollView + SelectableText.rich
└── verticalモード → VerticalTextViewer（新規ウィジェット）
    ├── VerticalTextPage（ページ内のWrapベースレンダリング）
    └── VerticalRubyTextWidget（右側ルビ配置）
```

**理由**:
- 既存の横書き表示のコードを変更せず、縦書き表示を並行して追加できる
- 表示モード切り替え時にウィジェットツリーが完全に切り替わるため、状態管理がシンプル

### 7. 検索ハイライト: 縦書き対応

**選択**: 縦書きモードでも既存の検索ハイライトロジックを適用（文字単位でハイライト色を設定）

**理由**:
- 文字ごとにWidgetを生成するため、個別文字のスタイル適用が容易

## Risks / Trade-offs

- **パフォーマンス**: 1文字ずつWidgetを生成するため、長い文書でレンダリングが遅くなる可能性がある → ページネーションにより1ページ分のみ描画することで軽減
- **テキスト選択不可**: Wrapウィジェット方式では`SelectableText`が使えないため、縦書きモードではテキスト選択・コピーができない → 横書きモードへの切り替えで対応
- **文字マッピングの網羅性**: 全ての縦書き互換文字をカバーしきれない可能性 → 主要な句読点・括弧を優先し、段階的に追加
- **フォントの縦書き対応**: 一部のフォントでは縦書き用グリフが正しく表示されない場合がある → システムフォントを前提とし、問題が発生した場合は個別対応
