## 1. 禁則文字定義モジュールの作成

- [ ] 1.1 `lib/features/text_viewer/data/kinsoku.dart` に行頭禁則文字セット（`kLineHeadForbidden`）と行末禁則文字セット（`kLineEndForbidden`）を定義する
- [ ] 1.2 `isLineHeadForbidden(String char)` と `isLineEndForbidden(String char)` の判定関数を実装する
- [ ] 1.3 `test/features/text_viewer/data/kinsoku_test.dart` に禁則文字判定のテストを作成する（句読点、括弧、小書き仮名、非禁則文字の各カテゴリ）

## 2. フラット文字エントリの作成

- [ ] 2.1 セグメントリストをフラットな文字エントリリストに変換する関数を `vertical_text_viewer.dart` に実装する（各エントリは文字、元セグメント種別、ルビセグメント参照を持つ）
- [ ] 2.2 `PlainTextSegment` は1文字ずつフラット化し、`RubyTextSegment` は1つの不可分ユニットとしてフラット化する
- [ ] 2.3 フラット化関数のユニットテストを作成する

## 3. 禁則対応カラム分割の実装

- [ ] 3.1 フラット文字リストに対して `charsPerColumn` で分割しつつ禁則ルールを適用するカラム分割関数を実装する
- [ ] 3.2 行頭禁則処理：カラム境界の次の文字が行頭禁則文字の場合、その文字を現在のカラムに含める（最大1文字の調整）
- [ ] 3.3 行末禁則処理：カラム末尾の文字が行末禁則文字の場合、その文字を次のカラムに移動する（最大1文字の調整）
- [ ] 3.4 フラット文字エントリから `List<TextSegment>` のカラムリストを再構築するロジックを実装する
- [ ] 3.5 既存の `_splitLineIntoColumns`、`_addPlainTextToColumns`、`_addRubyTextToColumns` を新しい禁則対応カラム分割に置き換える

## 4. 禁則処理のテスト

- [ ] 4.1 行頭禁則文字がカラム先頭に来ない（前のカラムに含まれる）ことを検証するテストを作成する
- [ ] 4.2 行末禁則文字がカラム末尾に来ない（次のカラムに移動される）ことを検証するテストを作成する
- [ ] 4.3 禁則違反がない場合は標準の `charsPerColumn` で分割されることを検証するテストを作成する
- [ ] 4.4 `RubyTextSegment` の先頭文字が行頭禁則文字の場合、ルビ全体が前のカラムに含まれることを検証するテストを作成する
- [ ] 4.5 最初のカラムの先頭が行頭禁則文字でも調整されないことを検証するテストを作成する
- [ ] 4.6 行末の最後のカラムが行末禁則文字で終わっても調整されないことを検証するテストを作成する

## 5. ページネーションとの統合

- [ ] 5.1 禁則処理によりカラム文字数が変動した場合、`_groupColumnsIntoPages` の幅計算が各カラムの実際の文字数を使用することを確認する
- [ ] 5.2 禁則処理を含むテキストでページネーションが正しく動作することを検証するテストを作成する
- [ ] 5.3 既存のページネーションテストが禁則処理導入後も通過することを確認し、必要に応じて期待値を調整する

## 6. 最終確認

- [ ] 6.1 code-simplifierエージェントを使用してコードをよりシンプルにできないか確認
- [ ] 6.2 codexスキルを使用して現在開発中のコードレビューを実施
- [ ] 6.3 `fvm flutter analyze`でリントを実行
- [ ] 6.4 `fvm flutter test`でテストを実行
