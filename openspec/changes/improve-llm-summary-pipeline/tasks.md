## 1. チャンク分割ロジック

- [ ] 1.1 コンテキストのリストを約4000文字ごとのチャンクに分割するクラス/関数を作成（コンテキスト境界で分割、単一エントリが4000文字超の場合はそのまま1チャンクに）
- [ ] 1.2 チャンク分割のユニットテストを作成（通常分割、単一チャンク、大きなエントリ）

## 2. プロンプト構築の変更

- [ ] 2.1 事実抽出プロンプト（`<term>` + `<context>` → JSON `{"facts": "..."}` の箇条書き）を `LlmPromptBuilder` に追加
- [ ] 2.2 最終要約プロンプト（`<term>` + `<facts>` → JSON `{"summary": "..."}` の1〜2文説明）を `LlmPromptBuilder` に追加
- [ ] 2.3 プロンプト構築のユニットテストを作成
- [ ] 2.4 旧プロンプト（`buildSpoilerPrompt` / `buildNoSpoilerPrompt`）を削除

## 3. パイプラインサービスの実装

- [ ] 3.1 再帰的な事実抽出・集約ロジックを実装（チャンク分割→LLM事実抽出→結合→4000文字超なら再帰、上限5回）
- [ ] 3.2 パイプラインサービスのユニットテストを作成（1チャンク、複数チャンク、再帰発生、再帰上限到達）

## 4. LlmSummaryServiceの統合

- [ ] 4.1 `LlmSummaryService.generateSummary` をパイプラインを使用するように変更（10件制限の撤廃、ネタバレ制御はフィルタリング段階で維持）
- [ ] 4.2 `LlmSummaryService` の既存テストを新しいパイプライン方式に合わせて更新

## 5. 最終確認

- [ ] 5.1 code-simplifierエージェントを使用してコードをよりシンプルにできないか確認
- [ ] 5.2 codexスキルを使用して現在開発中のコードレビューを実施
- [ ] 5.3 `fvm flutter analyze`でリントを実行
- [ ] 5.4 `fvm flutter test`でテストを実行
