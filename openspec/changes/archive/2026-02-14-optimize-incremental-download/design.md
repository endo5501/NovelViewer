## Context

現在の差分ダウンロードは、各エピソードに対してHEADリクエストを送信し、HTTPの`Last-Modified`ヘッダーでキャッシュと比較している。この方式では全エピソードがスキップされる場合でも、エピソード数×(HEADリクエスト時間+700ms待機)の時間がかかる。

なろう・カクヨムの目次ページにはエピソードごとの更新日時情報が含まれており、これを活用すればインデックスページ1回のGETのみで全エピソードの更新判定が可能。

## Goals / Non-Goals

**Goals:**
- インデックスページの日時情報を使った更新判定により、差分ダウンロードを高速化する
- 全エピソードスキップ時にネットワークリクエストをインデックス取得の1回に削減する
- スキップ時のレート制限待機を省略する

**Non-Goals:**
- カクヨムのエピソード改稿検知の完全性（`publishedAt`が変わらない改稿は検知しない）
- サイト構造変更への自動対応

## Decisions

### 1. Episode モデルに `updatedAt` フィールドを追加

`Episode` クラスに `String? updatedAt` を追加し、`parseIndex` 時に日時文字列を格納する。

**理由**: 更新判定に必要な情報をパース段階で取得し、ダウンロードループに渡す。型を `String?` にすることで、サイトごとの日時フォーマットの違いを吸収し、単純な文字列比較で判定できる。

**代替案**: `DateTime` 型にしてパース時に変換する案もあるが、フォーマット差異の吸収コストが不要な文字列比較で十分。

### 2. なろうの日時抽出ロジック

`p-eplist__update` 内から以下の優先順位で日時を取得:
1. `<span title="YYYY/MM/DD HH:MM 改稿">` がある場合 → title属性の改稿日時
2. ない場合 → `p-eplist__update` のテキスト（投稿日時）

**理由**: 改稿日時が最新の更新日時を表す。改稿がない場合は投稿日時が唯一の日時情報。

### 3. カクヨムの日時抽出ロジック

エピソードリンク内の `<time dateTime="...">` 属性値を取得する。

**理由**: `dateTime` 属性はISO 8601形式で機械可読。現在のパーサーが `a[href*="/episodes/"]` でリンクを取得しているので、その子要素から `<time>` を探す。

### 4. スキップ判定の変更

現在の `_downloadSingleEpisode` 内のHEADリクエスト+Last-Modified比較を、`episode.updatedAt` と `cache.lastModified` の文字列比較に置き換える。

```
現在:  cache存在 → ファイル存在 → HEADリクエスト → Last-Modified比較
改善後: cache存在 → ファイル存在 → episode.updatedAt vs cache.lastModified 比較
```

**理由**: ネットワークリクエストが不要になり、O(1)で判定可能。

### 5. キャッシュの `lastModified` フィールドの意味変更

`episode_cache` テーブルの `last_modified` カラムに保存する値を、HTTP Last-Modifiedヘッダーからインデックスページのエピソード日時に変更する。

**理由**: DBスキーマの変更は不要（同じTEXTカラム）。保存する値の意味が変わるだけ。既存のキャッシュとの互換性は、初回の差分チェック時に日時フォーマットが異なるため全エピソードが再ダウンロードされるが、2回目以降は正常に動作する。

### 6. レート制限の適用タイミング変更

スキップしたエピソードの後は700ms待機を行わない。実際にGETリクエストを行うエピソードの前のみ待機する。

**理由**: スキップ判定はローカル処理のみで完結するため、サーバーへの負荷がない。

### 7. `fetchHead` メソッドの削除

HEADリクエストによる更新判定が不要になるため、`fetchHead` メソッドを削除する。

**理由**: 使用箇所がなくなるため、不要なコードを残さない。

## Risks / Trade-offs

- **カクヨムの改稿未検知** → `publishedAt` が変わらない改稿は検知できない。問題が発生した場合に対応する。
- **サイトHTML構造の変更** → パーサーが壊れる可能性がある。`updatedAt` が `null` の場合は常にダウンロードする（安全側に倒す）フォールバックで対応。
- **既存キャッシュとの互換性** → 日時フォーマットが異なるため、初回は全エピソード再ダウンロード。2回目以降は正常動作。実質的な問題なし。
