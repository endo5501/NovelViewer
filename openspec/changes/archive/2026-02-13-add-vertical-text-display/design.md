## Context

NovelViewerは現在、`SingleChildScrollView` + `SelectableText.rich` による横書きスクロール表示のみをサポートしている。テキストはルビテキストパーサーでパースされ、`TextSpan` / `WidgetSpan` のツリーとして描画されている。設定画面はプレースホルダー状態で、設定の永続化レイヤーは存在しない。

参考情報として、Qiita記事（`Wrap`ウィジェットによる縦書き実装）と`yokogaki`パッケージ（横書き用だがルビ・禁則処理対応）を調査済み。

## Goals / Non-Goals

**Goals:**
- 縦書き（上→下、右→左）テキスト表示の実現
- 縦書き時のルビテキスト表示（ベーステキスト右側配置）
- 縦書き時のページネーション表示（スクロールではなくページ単位）
- 横矢印キー（←→）によるページ送り・戻り
- 設定画面での縦書き／横書き切り替え
- 設定の永続化（`shared_preferences`）

**Non-Goals:**
- フォントサイズや行間の設定変更（将来の拡張として残す）
- 禁則処理の完全実装（基本的な改行処理のみ）
- 縦書きモードでのテキスト選択・コピー機能（技術的制約により横書きのみ）
- 横書きモードのページネーション対応（横書きは従来通りスクロール）

## Decisions

### 1. 縦書きレンダリング方式: Wrapウィジェット方式

**選択**: `Wrap(direction: Axis.vertical)` + `textDirection: TextDirection.rtl` + 1文字ずつ描画

**理由**:
- Qiita記事で実証済みのアプローチで、Flutterの標準ウィジェットのみで実現可能
- 文字ごとにWidgetを生成するため、縦書き用文字マッピングや句読点の位置調整が容易
- CustomPainter方式と比較して実装がシンプルで保守しやすい

**代替案**:
- CustomPainter + TextPainter: より細かい制御が可能だが、改行処理やルビ配置の実装が複雑
- yokogakiパッケージ: 横書き専用であり、縦書きには対応していない

### 2. 文字マッピング: 縦書き用互換文字テーブル

**選択**: 横書き文字→縦書き互換文字のマッピングテーブルを`Map<String, String>`で定義

**マッピング対象**（Qiita記事のVerticalRotated全50ペア + NovelViewer独自追加を網羅）:
- スペース: `' '` → `'　'`
- 矢印: `↑↓←→` を90°回転
- 句読点: `。` → `︒`, `、` → `︑`, `,` → `︐`, `､` → `︑`
- 長音・ダッシュ類: `ー`, `ｰ`, `-`, `_`, `−`, `－`, `─`, `—` → `丨`
- 波線: `〜`, `～` → `丨`
- スラッシュ: `／` → `＼`
- リーダー: `…` → `︙`, `‥` → `︰`
- コロン・セミコロン: `：` `：` → `︓`, `；` `;` → `︔`
- イコール: `＝` `=` → `॥`
- 括弧: `（）()` → `︵︶`, `「」｢｣` → `﹁﹂`, `『』` → `﹃﹄`, `【】` → `︻︼`, `〖〗` → `︗︘`, `[]［］` → `﹇﹈`, `{}｛｝` → `︷︸`, `<>＜＞` → `︿﹀`
- NovelViewer独自: `〔〕` → `︹︺`, `〈〉` → `︿﹀`, `《》` → `︽︾`

### 3. ページネーション: 表示領域に基づくページ分割

**選択**: 表示領域のサイズを計算し、文字数と行数からページ境界を動的に決定

**理由**:
- ウィンドウサイズの変更に対応できる
- フォントサイズ変更への将来的な拡張が容易

**ページ送り方向**:
- `←`キー: 次のページ（縦書きは右→左なので、左キーで進む）
- `→`キー: 前のページ

### 4. 縦書きルビテキスト: Row配置（右側にルビ）

**選択**: 横書きでの`Column`（上にルビ）を、縦書きでは`Row`（右側にルビ）に切り替え

**理由**:
- 既存の`RubyTextWidget`の構造を活かしつつ、レイアウト方向のみ変更する
- 縦書きの日本語組版規則に従い、ルビはベーステキストの右側に配置

### 5. 設定の永続化: shared_preferences

**選択**: `shared_preferences`パッケージを使用

**理由**:
- Flutterの標準的なKey-Value永続化ソリューション
- macOS対応済み
- 簡単な設定値（表示モードのenum）の保存に適切
- Riverpodの`StateNotifier`と組み合わせてリアクティブに設定変更を反映

### 6. アーキテクチャ: 表示モード分岐方式

**選択**: `TextViewerPanel`内で表示モードに応じてウィジェットを切り替え

```
TextViewerPanel
├── horizontalモード → 既存のSingleChildScrollView + SelectableText.rich
└── verticalモード → VerticalTextViewer（新規ウィジェット）
    ├── VerticalTextPage（ページ内のWrapベースレンダリング）
    └── VerticalRubyTextWidget（右側ルビ配置）
```

**理由**:
- 既存の横書き表示のコードを変更せず、縦書き表示を並行して追加できる
- 表示モード切り替え時にウィジェットツリーが完全に切り替わるため、状態管理がシンプル

### 7. 検索ハイライト: 縦書き対応

**選択**: 縦書きモードでも既存の検索ハイライトロジックを適用（文字単位でハイライト色を設定）

**理由**:
- 文字ごとにWidgetを生成するため、個別文字のスタイル適用が容易

## Known Issues / Fixes

### Issue 1: テキストが左辺カラムへはみ出す

**現象**: テキストの開始位置が表示領域の左端を超えて描画される。

**原因分析**: ページネーション（`_paginateLines`）は改行で区切られた「行」を1カラムとしてカウントし、`columnsPerPage`を計算している。しかし`Wrap(direction: Axis.vertical)`は、利用可能な**高さ**に収まりきらない文字を自動的に次のカラム（左方向）に折り返す。つまり、文字数の多い行は複数の視覚的カラムを占有するが、ページネーションはこれを1カラムとして扱うためカラム数が超過し、左側にはみ出す。

**修正方針**: ページネーションで利用可能な高さ（`constraints.maxHeight`）も考慮する。各行が占有する視覚的カラム数を`(行の文字数 * 文字高さ / 利用可能高さ).ceil()`で推定し、ページあたりの視覚カラム上限に達するまで行を割り当てる。

### Issue 2: 縦方向の文字間スペースが広すぎる

**現象**: 文字間の縦方向の隙間が目立ち、読みにくい。

**原因分析**: 2つの要因が重なっている。
1. `Wrap`の`spacing: 2.0`が文字間に余分な間隔を追加している
2. `_buildCharWidget`で生成する`Text`ウィジェットにTextStyleの`height`が未設定のため、デフォルトの行の高さ（約1.2〜1.5倍）が適用されている（`VerticalRubyTextWidget`では`height: 1.0`を設定済みだが、通常文字には未設定）

**修正方針**: `Wrap`の`spacing`を`0.0`に変更し、`_buildCharWidget`内でTextStyleの`height`を`1.1`程度に設定する。

### Issue 3: Qiita記事のVerticalRotatedマッピングが網羅されていない

**現象**: 長音符「ー」をはじめ、多くの文字が縦書き用に変換されていない。

**原因分析**: `verticalCharMap`はQiita記事のVerticalRotatedマッピング（全50ペア）のうち一部しかカバーしていない。以下のカテゴリが不足している。

**現在のマップにない要素（追加が必要）**:

| カテゴリ | 不足しているマッピング |
|----------|----------------------|
| スペース | `' '` → `'　'`（半角→全角スペース） |
| 矢印 | `'↑'`→`'→'`, `'↓'`→`'←'`, `'←'`→`'↑'`, `'→'`→`'↓'`（90°回転） |
| 長音・ダッシュ類 | `'ー'`→`'丨'`, `'ｰ'`→`'丨'`, `'-'`→`'丨'`, `'_'`→`'丨'`, `'−'`→`'丨'`, `'－'`→`'丨'` |
| 波線 | `'〜'`→`'丨'`, `'～'`→`'丨'` |
| スラッシュ | `'／'`→`'＼'` |
| 二点リーダー | `'‥'`→`'︰'` |
| コロン・セミコロン | `'：'`→`'︓'`, `':'`→`'︓'`, `'；'`→`'︔'`, `';'`→`'︔'` |
| イコール | `'＝'`→`'॥'`, `'='`→`'॥'` |
| 角括弧（半角） | `'['`→`'﹇'`, `']'`→`'﹈'`, `'［'`→`'﹇'`, `'］'`→`'﹈'` |
| 波括弧（半角） | `'{'`→`'︷'`, `'}'`→`'︸'` |
| 不等号 | `'＜'`→`'︿'`, `'<'`→`'︿'`, `'＞'`→`'﹀'`, `'>'`→`'﹀'` |
| 半角カギ括弧 | `'｢'`→`'﹁'`, `'｣'`→`'﹂'` |
| 半角読点 | `'､'`→`'︑'` |

**既存マッピングの修正が必要な要素**:

| キー | 現在の値 | Qiita記事の値 | 対応 |
|------|---------|-------------|------|
| `'─'` | `'│'` | `'丨'` | Qiita記事に合わせる |
| `'—'` | `'︱'` | `'丨'` | Qiita記事に合わせる |
| `'.'` | `'.'`（変換なし） | （マッピングなし） | エントリ自体を削除 |

**修正方針**: Qiita記事のVerticalRotatedマッピング全50ペアを`verticalCharMap`に網羅的に反映する。既存のNovelViewer固有のマッピング（`〔〕`, `《》`等）はQiita記事にないが有用なため維持する。

### Issue 4: ルビ付き文字のベーステキストが左にずれる

**現象**: ルビ付き文字のベーステキスト（漢字等）が、ルビなし文字に比べて左側にずれて表示される。

**原因分析**: `VerticalRubyTextWidget`が`Row`でルビとベーステキストを横に並べるため、ウィジェット全体の幅が`ルビ幅(fontSize*0.5) + ベース幅(fontSize)`となる。Wrapはカラム内の最も幅広いウィジェットに合わせてカラム幅を決定するため、ルビ付き文字のカラムは通常文字より広くなる。さらにRTLコンテキストでルビが右側起点に配置されるため、ベーステキストが左に押し出される。

**修正方針**: `Row`方式から`Stack`方式に変更する。ベーステキストを通常の文字と同じ幅で描画し、ルビテキストを`Positioned`または`Transform.translate`でベーステキストの右側にオーバーレイする。これによりルビがWrapのカラム幅計算に影響しなくなり、ベーステキストの位置が他の文字と揃う。

## Risks / Trade-offs

- **パフォーマンス**: 1文字ずつWidgetを生成するため、長い文書でレンダリングが遅くなる可能性がある → ページネーションにより1ページ分のみ描画することで軽減
- **テキスト選択不可**: Wrapウィジェット方式では`SelectableText`が使えないため、縦書きモードではテキスト選択・コピーができない → 横書きモードへの切り替えで対応
- **文字マッピングの網羅性**: 全ての縦書き互換文字をカバーしきれない可能性 → 主要な句読点・括弧を優先し、段階的に追加
- **フォントの縦書き対応**: 一部のフォントでは縦書き用グリフが正しく表示されない場合がある → システムフォントを前提とし、問題が発生した場合は個別対応
