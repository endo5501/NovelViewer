## Context

なろうの長編小説は目次ページが100話ごとにページ分割される。例えば192話の小説は2ページ（1〜100話、101〜192話）に分かれる。URLは `?p=N` パラメータでページを指定する（1ページ目はパラメータなし）。

現在の実装では `DownloadService.downloadNovel` が1回だけ `_fetchPageResponse(url)` を呼び、`site.parseIndex()` で1ページ分のエピソードリストを取得している。ページネーションの概念は存在しない。

なろうのページネーションHTMLは専用CSSクラスを持たず、プレーンテキストとアンカータグで構成される：
- 「最後へ」がリンクなら後続ページが存在
- 「最後へ」がプレーンテキストなら最終ページ
- リンクのhrefには `?p=N` が含まれる

カクヨムは全エピソードを1ページに表示するため、ページネーション対応は不要。

## Goals / Non-Goals

**Goals:**
- なろうの目次ページのページネーションを検出し、全ページのエピソードを取得する
- 全ページを通じてエピソード番号を1から連番で割り当てる
- ユーザーが途中のページURL（`?p=2`）を指定しても、全ページを取得する
- 既存のレートリミット（700ms）をページネーション取得にも適用する

**Non-Goals:**
- カクヨムのページネーション対応（現時点では不要）
- 特定ページ範囲のみのダウンロード機能
- ページネーション情報のキャッシュ

## Decisions

### 1. ページネーション情報を `NovelIndex` に追加する

**決定**: `NovelIndex` に `nextPageUrl` フィールド（`Uri?`）を追加する。

**理由**: ページネーションの検出はサイト固有のHTMLパース処理であり、`parseIndex` の責務として自然に収まる。`NovelIndex` に次ページURLを含めることで、`DownloadService` は汎用的なループ処理で複数ページを処理できる。

**代替案**:
- `NovelSite` インターフェースに `fetchAllPages` メソッドを追加する案 → サイト側にHTTP通信の責務が発生し、関心の分離が崩れるため不採用
- `DownloadService` にサイト固有のページネーション検出を持たせる案 → サイト固有のHTMLパースロジックが `DownloadService` に漏れ出すため不採用

### 2. `DownloadService` でマルチページインデックス取得ループを実装する

**決定**: `downloadNovel` メソッド内で、`parseIndex` 結果の `nextPageUrl` が non-null である限りページを追加取得し、エピソードリストをマージする。

**処理フロー**:
1. 最初のインデックスページを取得・パース
2. `nextPageUrl` が存在すれば、レートリミット後にそのURLを取得
3. 追加ページのエピソードをリストに追加（インデックス番号はオフセットを加算して連番化）
4. `nextPageUrl` が null になるまで繰り返す
5. マージしたエピソードリストで通常のダウンロード処理を実行

**理由**: HTTP通信は `DownloadService` の既存の責務であり、ページネーションのフェッチループは自然にここに収まる。

### 3. URL正規化でページパラメータを除去する

**決定**: `NarouSite.normalizeUrl` で `?p=N` パラメータを除去し、常にベースURLから開始する。入力URLに `?p=2` が含まれていても、1ページ目から全ページを取得する。

**理由**: ユーザーがどのページURLを入力しても一貫した動作を保証するため。

### 4. エピソード番号の連番割り当て

**決定**: `parseIndex` で返すエピソード番号はページ内のローカルインデックス（1始まり）のままとし、`DownloadService` のマージ時にグローバルオフセットを加算して連番化する。

**理由**: `parseIndex` はページ単体のパース処理であり、他ページの文脈を知るべきではない。番号の調整はマージを行う `DownloadService` の責務。

### 5. ページネーション検出方法

**決定**: `NarouSite.parseIndex` で「最後へ」を含むアンカータグ（`a[href*="?p="]`）を検索する。リンクテキストが「次へ」のアンカータグがあれば、そのhrefを `nextPageUrl` として設定する。

**理由**: なろうのページネーションは専用CSSクラスを持たないため、リンクテキストとhrefパターンで検出する。「次へ」リンクの有無で次ページの存在を判定するのが最もシンプル。

## Risks / Trade-offs

- **[ページ数が多い小説でのリクエスト増加]** → 各ページ取得にレートリミット（700ms）が適用されるため、サーバーへの負荷は制御される。10ページの小説でも追加は約7秒程度。
- **[なろうのHTML構造変更]** → ページネーションのリンクテキスト（「次へ」「最後へ」）に依存するため、サイト変更で壊れる可能性がある。→ テストでHTMLフィクスチャを使い、変更を早期に検出する。
- **[無限ループのリスク]** → パース不具合で `nextPageUrl` が永続的に返される場合、無限ループになりうる。→ 最大ページ数の上限（例：100ページ = 10,000話）を設けるガードを実装する。
- **[途中ページURLの正規化]** → `?p=2` を入力した場合に正規化して `?p=` なしから開始する。ユーザーが意図的に途中ページだけをダウンロードしたいケースは Non-Goal として除外済み。
