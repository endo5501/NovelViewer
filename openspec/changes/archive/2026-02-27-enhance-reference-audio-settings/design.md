## Context

現在のリファレンス音声ファイル設定は `DropdownButtonFormField` による選択のみで、ファイルの追加・リネームはvoicesフォルダを直接操作する必要がある。`VoiceReferenceService` がvoicesディレクトリの管理を担当し、`settings_dialog.dart` の `_buildVoiceReferenceSelector()` がUIを構築している。

## Goals / Non-Goals

**Goals:**
- 設定画面にD&Dでリファレンス音声ファイルを追加できるようにする
- 設定画面上でリファレンス音声ファイルのリネームができるようにする
- 追加・リネーム時に適切なバリデーションを行う（拡張子、重複チェック）

**Non-Goals:**
- 音声ファイルの削除機能（今回のスコープ外）
- 音声ファイルのプレビュー再生機能
- voicesフォルダ以外からのファイル参照

## Decisions

### 1. D&Dパッケージの選択: `desktop_drop`

**選択**: `desktop_drop` パッケージを使用する

**理由**: FlutterのネイティブD&D APIはウィジェット間のドラッグ操作向けであり、OSのファイルマネージャーからのファイルドロップには対応していない。`desktop_drop` はmacOS/Windows/Linuxでのネイティブファイルドロップに対応しており、デスクトップアプリで広く使われている。

**代替案**:
- Flutter標準の `Draggable`/`DragTarget`: ネイティブファイルドロップ非対応
- `super_drag_and_drop`: より新しいパッケージだが、`desktop_drop` で十分

### 2. ファイル追加方式: コピーベース

**選択**: ドロップされたファイルをvoicesディレクトリにコピーする

**理由**: 元ファイルへの参照（シンボリックリンク等）はファイル移動時に壊れるリスクがある。コピーすることで音声ファイルがアプリ管理下に確実に配置される。

### 3. リネームUI: 編集ボタン + ダイアログ

**選択**: ドロップダウンの横に編集ボタンを追加し、クリック時にリネームダイアログを表示する

**理由**: ドロップダウン内でのインライン編集は技術的に複雑で、誤操作のリスクが高い。ダイアログ方式なら確認・キャンセルが容易で、拡張子の自動付与やバリデーションメッセージの表示スペースも確保できる。

**代替案**:
- ドロップダウン内インライン編集: UX的にはシンプルだが、FlutterのDropdownではカスタムが困難
- リスト表示 + 個別リネーム: UIの大幅変更が必要で過剰

### 4. UIレイアウト: ドロップゾーンでセレクター全体をラップ

**選択**: `DropTarget` ウィジェットでリファレンス音声ファイル選択エリア全体を囲む。ドラッグ中はボーダーのハイライトで視覚フィードバックを表示する。

**レイアウト構成**:
```
[ドロップゾーン（破線ボーダー）]
  ├─ [ドロップダウン] [編集ボタン] [リフレッシュ] [フォルダ]
  └─ ドラッグ中: "音声ファイルをここにドロップ" メッセージ
```

### 5. サービス層の拡張

`VoiceReferenceService` に以下のメソッドを追加:
- `addVoiceFile(String sourcePath)`: ファイルをvoicesディレクトリにコピー。戻り値はコピー後のファイル名。
- `renameVoiceFile(String oldName, String newName)`: voicesディレクトリ内のファイルをリネーム。

### 6. リネーム時の選択ファイル更新

リネームされたファイルが現在選択中のファイルだった場合、`ttsRefWavPathProvider` の値を新しいファイル名に自動更新する。

## Risks / Trade-offs

- **`desktop_drop` パッケージ依存**: メンテナンスが停止するリスク → 十分な利用実績があり、必要ならネイティブAPIで代替可能
- **ファイルコピーによるディスク使用量増加**: 大きな音声ファイルが重複する → 音声リファレンスファイルは通常小さいため問題にならない
- **リネーム中の競合**: TTS再生中にリネームされた場合 → 再生中のファイルパスは既に解決済みのため影響なし。次回再生時に新しいパスが使われる
