## Context

現在TTSモデルデータのセットアップはユーザがPythonスクリプトでGGUFファイルを生成し、手動で配置後、設定画面からパスを指定する手順となっている。HuggingFaceのkoboldcppリポジトリで変換済みモデルが公開されたため、アプリ内から直接ダウンロードできるようにする。

既存のアーキテクチャはfeature-based構成でRiverpodによる状態管理を使用しており、HTTPクライアントは `http` パッケージを利用している。ダウンロード先のパスは `NovelLibraryService` のパス解決ロジック（macOS: `~/Documents`、Windows: exe同階層）と同じ親ディレクトリに `models` フォルダを作成する。

## Goals / Non-Goals

**Goals:**
- 設定画面の「読み上げ」タブからワンクリックでTTSモデル2ファイルをダウンロードできる
- ダウンロード進捗をプログレスバーで表示する
- ダウンロード完了後、モデルディレクトリパスを自動設定する
- 既にダウンロード済みの場合はその旨を表示する

**Non-Goals:**
- モデルのバージョン管理・自動更新
- ダウンロード中断・レジューム機能
- ダウンロードURLのユーザカスタマイズ
- 複数モデルの選択機能

## Decisions

### 1. ダウンロードサービスの配置

**決定**: `lib/features/tts/data/tts_model_download_service.dart` に新規サービスクラスを作成する。

**理由**: TTS機能に密接に関連するため、既存の `tts` feature内に配置する。既存の `DownloadService` は小説テキストのダウンロードに特化しており（HTMLパース、エピソード管理等）、バイナリファイルのダウンロードとは責務が異なるため再利用せず新規に作成する。

### 2. HTTPダウンロード方式

**決定**: `http` パッケージの `Client.send()` + `StreamedResponse` を使用してストリーミングダウンロードする。

**理由**: GGUFモデルファイルは数百MB〜数GBのサイズになりうるため、全体をメモリに読み込む `get()` ではなく、ストリーミングでファイルに直接書き出す方式が必要。`Content-Length` ヘッダからファイルサイズを取得し、進捗表示に使用する。

**代替案**: `dio` パッケージの利用 → 新規依存を追加するメリットが薄いため却下。

### 3. ダウンロード先パスの決定

**決定**: `libraryPathProvider` から取得したライブラリパス（例: `~/Documents/NovelViewer`）の親ディレクトリに `models` フォルダを作成する。

**パス例**:
- macOS: `~/Documents/models/`
- Windows: `{exeDir}/models/`

**理由**: ユーザが要求した「テキストデータの保存先と同じ階層」という仕様に合致する。`libraryPathProvider` は起動時に確定しており、追加のパス解決ロジックが不要。

### 4. 状態管理

**決定**: ダウンロード状態を表すsealed classと、それを管理するRiverpod `AsyncNotifierProvider` を使用する。

```
TtsModelDownloadState:
  - idle (未ダウンロード)
  - checking (ファイル存在確認中)
  - downloading (progress: double, currentFile: String)
  - completed
  - error (message: String)
```

**理由**: 既存のプロジェクトがRiverpodを使用しており、一貫性を保つ。UIの状態表示もシンプルに実装できる。

### 5. ダウンロード済み判定

**決定**: `models` フォルダ内に2つのGGUFファイルが存在し、かつファイルサイズが0より大きい場合にダウンロード済みとみなす。

**理由**: シンプルかつ十分な判定方法。ハッシュ検証等はNon-Goalのバージョン管理に属するため対象外。

### 6. UIの配置

**決定**: TTSタブの既存フィールド（モデルディレクトリ、WAVファイル）の上部に、ダウンロードセクションを配置する。

**構成**:
- ダウンロード済み: 「モデルダウンロード済み」のステータス表示 + パス表示
- 未ダウンロード: 「モデルデータダウンロード」ボタン
- ダウンロード中: プログレスバー + ファイル名 + 進捗率

**理由**: モデルディレクトリの手動設定よりもダウンロードの方が主要なユースケースとなるため、上部に配置してユーザの目に入りやすくする。

### 7. ダウンロード完了後の自動設定

**決定**: ダウンロード完了時に `ttsModelDirProvider` を通じてモデルディレクトリパスを自動的に設定し、UIのテキストフィールドにも反映する。

**理由**: ユーザが手動でパスを設定する手間を省くため。ただし、既に別のパスが設定されている場合も上書きする（ダウンロードボタンを押した＝このモデルを使いたい意思表示と解釈）。

## Risks / Trade-offs

- **大容量ファイルのダウンロード失敗** → エラーメッセージを表示し、再試行ボタンを提供する。部分ダウンロードファイルは削除してクリーンな状態を保つ。
- **HuggingFaceのURL変更** → URLはサービスクラス内に定数として定義し、変更時は1箇所の修正で対応できるようにする。
- **ディスク容量不足** → ダウンロード中のIOExceptionをキャッチしてエラー表示する。事前のディスク容量チェックはプラットフォーム差異が大きいため行わない。
- **ネットワーク未接続** → SocketExceptionをキャッチしてネットワークエラーとして表示する。
